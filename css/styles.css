/* =================== UTILIDADES =================== */

function PRNG(seed) {
  let t = seed;
  return function () {
    t = (t * 1664525 + 1013904223) % 4294967296;
    return t / 4294967296;
  };
}

const rnd = PRNG(20251116);

function clamp(v, a, b) {
  return Math.max(a, Math.min(b, v));
}

function roundByUnit(v, u) {
  if (u === "%") return Number(v.toFixed(1));
  if (u === "MM USD") return Number(v.toFixed(2));
  if (u === "‱") return Number(v.toFixed(1));
  if (u === "x") return Number(v.toFixed(1));
  if (u === "kWh/t" || u === "kg/t") return Number(v.toFixed(0));
  if (u === "h" || u === "min" || u === "pts" || u === "/mes") return Number(v.toFixed(0));
  return Number(v.toFixed(1));
}

/* =================== PERIODOS =================== */

const PERIODOS_ALL = [];
for (let y = 2024; y <= 2025; y++) {
  for (let m = 1; m <= 12; m++) {
    PERIODOS_ALL.push(`${y}-${String(m).padStart(2, "0")}`);
  }
}
const PERIODOS_SELECT = PERIODOS_ALL.filter((p) => p.startsWith("2025-"));

/* =================== PLANTILLAS KPI =================== */

const PLANTILLAS = {
  FIN: [
    { n: "Margen bruto", u: "%", pol: "up", base: 22.0, meta: 24.0, warn: 21.5, pres: 24.0 },
    { n: "EBITDA sobre ventas", u: "%", pol: "up", base: 10.5, meta: 12.0, warn: 9.5, pres: 12.0 },
    { n: "Flujo de caja operativo", u: "MM USD", pol: "up", base: 1.5, meta: 2.0, warn: 1.2, pres: 2.0 },
    { n: "Rotación de inventarios", u: "x", pol: "up", base: 6.8, meta: 7.2, warn: 6.3, pres: 7.0 }
  ],
  CLI: [
    { n: "OTIF", u: "%", pol: "up", base: 90, meta: 95, warn: 88, pres: 94 },
    { n: "Tasa de reacuerdos", u: "%", pol: "down", base: 8.5, meta: 5.0, warn: 7.5, pres: 6.0 },
    { n: "Reclamos por mil ordenes", u: "‱", pol: "down", base: 4.2, meta: 2.5, warn: 3.8, pres: 2.8 },
    { n: "NPS", u: "pts", pol: "up", base: 52, meta: 60, warn: 48, pres: 58 }
  ],
  PRO: [
    { n: "OEE", u: "%", pol: "up", base: 58, meta: 68, warn: 60, pres: 65 },
    { n: "Scrap", u: "%", pol: "down", base: 3.2, meta: 2.0, warn: 3.0, pres: 2.4 },
    { n: "MTTR", u: "min", pol: "down", base: 42, meta: 32, warn: 40, pres: 36 },
    { n: "MTBF", u: "h", pol: "up", base: 38, meta: 48, warn: 38, pres: 44 }
  ],
  APR: [
    { n: "Horas de capacitacion por persona", u: "h", pol: "up", base: 14, meta: 24, warn: 16, pres: 20 },
    { n: "Ideas de mejora implementadas", u: "/mes", pol: "up", base: 14, meta: 25, warn: 12, pres: 20 },
    { n: "Cumplimiento 5S", u: "%", pol: "up", base: 70, meta: 85, warn: 72, pres: 80 },
    { n: "Cobertura de roles criticos", u: "%", pol: "up", base: 64, meta: 80, warn: 68, pres: 75 }
  ],
  SUS: [
    { n: "Consumo de energia por tonelada", u: "kWh/t", pol: "down", base: 440, meta: 390, warn: 430, pres: 400 },
    { n: "Emisiones CO2 por tonelada", u: "kg/t", pol: "down", base: 205, meta: 170, warn: 200, pres: 180 },
    { n: "Residuos reciclados", u: "%", pol: "up", base: 58, meta: 75, warn: 60, pres: 70 }
  ]
};

function generaSerieTotal(t) {
  const arr = [];
  let v = t.base;
  for (let i = 0; i < 24; i++) {
    const dir = t.pol === "up" ? 1 : -1;
    const bias = dir * 0.006;
    let ruido;
    if (t.u === "%") ruido = 0.6;
    else if (t.u === "MM USD") ruido = 0.06;
    else if (t.u === "‱") ruido = 0.4;
    else if (t.u === "x") ruido = 0.04;
    else if (t.u === "min" || t.u === "h") ruido = 0.9;
    else ruido = 0.9;

    v = v * (1 + bias) + (rnd() * 2 - 1) * ruido;
    if (t.pol === "up") v = Math.max(v, t.warn * 0.85);
    else v = Math.min(v, t.warn * 1.2);

    arr.push(roundByUnit(v, t.u));
  }
  return arr;
}

/* Construccion de datos con Linea A y B */

function buildData() {
  const grupos = [
    { code: "FIN", id: "fin", nombre: "Finanzas" },
    { code: "CLI", id: "cli", nombre: "Cliente" },
    { code: "PRO", id: "pro", nombre: "Procesos internos" },
    { code: "APR", id: "apr", nombre: "Aprendizaje y crecimiento" },
    { code: "SUS", id: "sus", nombre: "Sostenibilidad" }
  ];

  const perspectivas = [];

  for (const g of grupos) {
    const kpis = PLANTILLAS[g.code].map((t) => {
      const sTotal = generaSerieTotal(t);

      const sA = sTotal.map((v) => {
        const factor = 1 + (rnd() * 2 - 1) * 0.05;
        return roundByUnit(v * factor, t.u);
      });
      const sB = sTotal.map((v) => {
        const factor = 1 + (rnd() * 2 - 1) * 0.05;
        return roundByUnit(v * factor, t.u);
      });

      const hist = {};
      PERIODOS_ALL.forEach((per, idx) => {
        const aA = sA[idx];
        const aB = sB[idx];
        const total = roundByUnit((aA + aB) / 2, t.u);
        hist[per] = {
          a: total,
          meta: t.meta,
          warn: t.warn,
          pres: t.pres,
          seg: {
            A: aA,
            B: aB
          }
        };
      });

      return {
        n: t.n,
        u: t.u,
        pol: t.pol,
        sTotal,
        sA,
        sB,
        hist
      };
    });

    perspectivas.push({ code: g.code, id: g.id, nombre: g.nombre, kpis });
  }

  return perspectivas;
}

const DATA = {
  periodosSelect: PERIODOS_SELECT,
  periodosAll: PERIODOS_ALL,
  perspectivas: buildData()
};

/* =================== FORMATOS Y ESTADOS =================== */

const MESES_ABR = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

function $(sel) {
  return document.querySelector(sel);
}

function fmt(v, u) {
  if (u === "%") return v.toFixed(1) + "%";
  if (u === "MM USD") return v.toFixed(2) + " MM";
  if (u === "‱") return v.toFixed(1);
  if (u === "h" || u === "min" || u === "pts" || u === "/mes") {
    if (u === "/mes") return v.toFixed(0) + " /mes";
    return v.toFixed(0) + " " + u;
  }
  if (u === "x") return v.toFixed(1) + "x";
  if (u === "kWh/t" || u === "kg/t") return v.toFixed(0) + " " + u;
  return v.toFixed(1) + (u ? " " + u : "");
}

function state(pol, a, meta, warn) {
  if (pol === "up") {
    if (a >= meta) return "good";
    if (a >= warn) return "warn";
    return "bad";
  } else {
    if (a <= meta) return "good";
    if (a <= warn) return "warn";
    return "bad";
  }
}

function pctDiff(cur, ref, pol) {
  if (!ref) return null;
  const d = ((cur - ref) / ref) * 100;
  const sign = pol === "up" ? d : -d;
  return sign;
}

function gaugeColor(pct) {
  if (pct >= 70) return "good";
  if (pct >= 40) return "warn";
  return "bad";
}

function fmtPeriodo(per) {
  const [y, m] = per.split("-");
  return MESES_ABR[Number(m) - 1] + "-" + y.slice(-2);
}

/* =================== BUSQUEDA DE KPI =================== */

function findKPIByName(name) {
  for (const p of DATA.perspectivas) {
    const f = p.kpis.find((k) => k.n === name);
    if (f) return { k: f, pers: p };
  }
  return null;
}

function getKPIStateForPeriod(name, periodo) {
  const ref = findKPIByName(name);
  if (!ref) return null;
  const h = ref.k.hist[periodo];
  return state(ref.k.pol, h.a, h.meta, h.warn);
}

function stateColor(st) {
  if (st === "good") return "#22c55e";
  if (st === "warn") return "#facc15";
  return "#f97373";
}

function aggregateState(drivers, periodo) {
  const sts = drivers
    .map((d) => getKPIStateForPeriod(d.kpi, periodo))
    .filter(Boolean);
  if (!sts.length) return "warn";
  if (sts.some((s) => s === "bad")) return "bad";
  if (sts.some((s) => s === "warn")) return "warn";
  return "good";
}

/* =================== ELEMENTOS DOM =================== */

const selPeriodo = $("#selPeriodo");
const summary = $("#summary");
const narrativaDiv = $("#narrative");

const blocks = {
  FIN: $("#fin .kpi-list"),
  CLI: $("#cli .kpi-list"),
  PRO: $("#pro .kpi-list"),
  APR: $("#apr .kpi-list"),
  SUS: $("#sus .kpi-list")
};

DATA.periodosSelect.forEach((p) => {
  const opt = document.createElement("option");
  opt.value = p;
  opt.textContent = p;
  selPeriodo.appendChild(opt);
});
selPeriodo.value = DATA.periodosSelect[DATA.periodosSelect.length - 1];

/* =================== RESUMEN PERSPECTIVAS =================== */

function renderSummary(periodo) {
  summary.innerHTML = "";
  DATA.perspectivas.forEach((p) => {
    const total = p.kpis.length;
    const greens = p.kpis.filter((k) => {
      const h = k.hist[periodo];
      return state(k.pol, h.a, h.meta, h.warn) === "good";
    }).length;
    const pct = Math.round((greens / total) * 100);

    const tile = document.createElement("div");
    tile.className = "tile";
    tile.innerHTML = `
      <h3>${p.nombre}</h3>
      <div class="gauge">
        <div class="bar ${gaugeColor(pct)}" style="width:${pct}%"></div>
      </div>
      <div class="pct">${greens}/${total} indicadores en verde - ${pct}%</div>
    `;
    summary.appendChild(tile);
  });
}

/* =================== TARJETAS KPI =================== */

let currentCmp = "mes";

document.querySelectorAll("button.toggle").forEach((b) => {
  b.addEventListener("click", () => {
    document.querySelectorAll("button.toggle").forEach((x) =>
      x.setAttribute("aria-pressed", "false")
    );
    b.setAttribute("aria-pressed", "true");
    currentCmp = b.dataset.cmp;
    renderAll();
  });
});

function refPeriodo(periodo) {
  const idx = DATA.periodosAll.indexOf(periodo);
  if (currentCmp === "mes") return DATA.periodosAll[idx - 1] || null;
  if (currentCmp === "tri") return DATA.periodosAll[idx - 3] || null;
  if (currentCmp === "anio") return DATA.periodosAll[idx - 12] || null;
  return "PRES";
}

function sparkPathCompact(arr, color) {
  const min = Math.min(...arr);
  const max = Math.max(...arr);
  const norm = (v) => 22 - ((v - min) / (max - min || 1)) * 18;
  const step = 100 / (arr.length - 1);
  let d = `M 0 ${norm(arr[0]).toFixed(2)} `;
  arr.forEach((v, i) => {
    d += `L ${(i * step).toFixed(2)} ${norm(v).toFixed(2)} `;
  });
  return `<path d="${d}" fill="none" stroke="${color}" stroke-width="1.5" />`;
}

function renderBlocks(periodo, filterText) {
  Object.values(blocks).forEach((el) => (el.innerHTML = ""));

  const filter = (filterText || "").toLowerCase();
  const ref = refPeriodo(periodo);

  DATA.perspectivas.forEach((p) => {
    const cont = blocks[p.code];
    p.kpis
      .filter((k) => !filter || k.n.toLowerCase().includes(filter))
      .forEach((k) => {
        const h = k.hist[periodo];
        const st = state(k.pol, h.a, h.meta, h.warn);

        let deltaStr = "";
        if (ref === "PRES") {
          const d = pctDiff(h.a, h.pres, k.pol);
          if (d != null) {
            deltaStr = `Delta vs presupuesto: ${(d >= 0 ? "+" : "") + d.toFixed(1)}%`;
          }
        } else if (ref && k.hist[ref]) {
          const d = pctDiff(h.a, k.hist[ref].a, k.pol);
          if (d != null) {
            deltaStr = `Delta vs ${fmtPeriodo(ref)}: ${(d >= 0 ? "+" : "") + d.toFixed(1)}%`;
          }
        }

        const series12 = k.sTotal.slice(-12);
        const colorSpark =
          st === "good" ? "#22c55e" : st === "warn" ? "#facc15" : "#f97373";

        const card = document.createElement("div");
        card.className = "kpi";
        card.innerHTML = `
          <div class="kpi-header">
            <span class="kpi-chip">${k.u}</span>
            <div class="kpi-name">${k.n}</div>
            <div class="kpi-sema ${st}" title="Estado actual"></div>
          </div>
          <div class="kpi-vals">
            <div class="kpi-actual">${fmt(h.a, k.u)}</div>
            <div class="kpi-meta">
              Budget: <b>${fmt(h.pres, k.u)}</b> · Meta: <b>${fmt(h.meta, k.u)}</b>
            </div>
            <div class="kpi-delta">${deltaStr}</div>
          </div>
          <div class="kpi-spark">
            <svg viewBox="0 0 100 24" preserveAspectRatio="none">
              ${sparkPathCompact(series12, colorSpark)}
            </svg>
          </div>
        `;
        card.addEventListener("click", () =>
          openModal(p.nombre, k, periodo)
        );
        cont.appendChild(card);
      });
  });
}

/* =================== MODAL DRILL DOWN =================== */

const modal = $("#modal");
const dlgTitle = $("#dlgTitle");
const dlgPersp = $("#dlgPersp");
const dlgSpark = $("#dlgSpark");
const dlgTbody = $("#dlgTbody");
const dlgMonths = $("#dlgMonths");
const btnClose = $("#btnClose");

btnClose.onclick = () => modal.classList.remove("show");
modal.addEventListener("click", (e) => {
  if (e.target === modal) modal.classList.remove("show");
});

function openModal(nombrePersp, k, periodo) {
  dlgPersp.textContent = nombrePersp;
  dlgTitle.textContent = k.n;
  renderSparkBig(k);
  renderBreakdown(k, periodo);
  renderMonthTable(k);
  modal.classList.add("show");
}

/* Spark grande con Total + Linea A + Linea B */

function renderSparkBig(k) {
  const w = dlgSpark.clientWidth || 360;
  const h = 230;
  const padL = 46;
  const padR = 16;
  const padT = 20;
  const padB = 32;

  dlgSpark.setAttribute("viewBox", `0 0 ${w} ${h}`);
  dlgSpark.innerHTML = "";

  const allSeries = [...k.sTotal, ...k.sA, ...k.sB];
  const min = Math.min(...allSeries);
  const max = Math.max(...allSeries);

  const y = (v) =>
    h - padB - ((v - min) / (max - min || 1)) * (h - padT - padB);
  const step = (w - padL - padR) / (k.sTotal.length - 1);

  for (let i = 0; i < 4; i++) {
    const y0 = padT + i * ((h - padT - padB) / 3);
    const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
    l.setAttribute("x1", padL.toString());
    l.setAttribute("x2", (w - padR).toString());
    l.setAttribute("y1", y0.toString());
    l.setAttribute("y2", y0.toString());
    l.setAttribute("stroke", "#1e293b");
    l.setAttribute("stroke-dasharray", "3 4");
    dlgSpark.appendChild(l);
  }

  const ejemploHist = k.hist[DATA.periodosSelect[0]];
  const meta = ejemploHist.meta;
  const warn = ejemploHist.warn;

  function mkLine(val, col) {
    const L = document.createElementNS("http://www.w3.org/2000/svg", "line");
    L.setAttribute("x1", padL.toString());
    L.setAttribute("x2", (w - padR).toString());
    L.setAttribute("y1", y(val).toString());
    L.setAttribute("y2", y(val).toString());
    L.setAttribute("stroke", col);
    L.setAttribute("stroke-width", "1.1");
    L.setAttribute("stroke-dasharray", "6 6");
    return L;
  }

  dlgSpark.appendChild(mkLine(meta, "#22c55e"));
  dlgSpark.appendChild(mkLine(warn, "#facc15"));

  const yVals = [max, min];
  yVals.forEach((val, idx) => {
    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
    txt.setAttribute("x", (padL - 10).toString());
    txt.setAttribute(
      "y",
      (y(val) + (idx === 0 ? -4 : 10)).toString()
    );
    txt.setAttribute("text-anchor", "end");
    txt.setAttribute("fill", "#9ca3af");
    txt.setAttribute("font-size", "10");
    txt.textContent = fmt(val, k.u);
    dlgSpark.appendChild(txt);
  });

  function drawSeries(arr, color, width, dash) {
    let d = `M ${padL} ${y(arr[0]).toFixed(2)} `;
    arr.forEach((v, i) => {
      d += `L ${(padL + i * step).toFixed(2)} ${y(v).toFixed(2)} `;
    });
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", d);
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", color);
    path.setAttribute("stroke-width", width.toString());
    if (dash) path.setAttribute("stroke-dasharray", dash);
    dlgSpark.appendChild(path);
  }

  drawSeries(k.sTotal, "#60a5fa", 2.2, "");
  drawSeries(k.sA, "#22c55e", 1.6, "4 3");
  drawSeries(k.sB, "#f97316", 1.6, "4 3");

  PERIODOS_ALL.forEach((per, idx) => {
    const x = padL + idx * step;
    const tick = document.createElementNS("http://www.w3.org/2000/svg", "line");
    tick.setAttribute("x1", x.toString());
    tick.setAttribute("x2", x.toString());
    tick.setAttribute("y1", (h - padB).toString());
    tick.setAttribute("y2", (h - padB + 4).toString());
    tick.setAttribute("stroke", "#475569");
    tick.setAttribute("stroke-width", "0.8");
    dlgSpark.appendChild(tick);

    if (idx % 2 === 0) {
      const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
      t.setAttribute("x", x.toString());
      t.setAttribute("y", (h - 4).toString());
      t.setAttribute("text-anchor", "middle");
      t.setAttribute("fill", "#9ca3af");
      t.setAttribute("font-size", "9");
      t.textContent = fmtPeriodo(per);
      dlgSpark.appendChild(t);
    }
  });
}

function renderBreakdown(k, periodo) {
  dlgTbody.innerHTML = "";
  const h = k.hist[periodo];

  const segs = [
    { id: "A", nombre: "Linea A" },
    { id: "B", nombre: "Linea B" }
  ];

  segs.forEach((s) => {
    const val = h.seg[s.id];
    const st = state(k.pol, val, h.meta, h.warn);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.nombre}</td>
      <td>${fmt(val, k.u)}</td>
      <td>${fmt(h.meta, k.u)}</td>
      <td><span class="pill ${st}">${st.toUpperCase()}</span></td>
    `;
    dlgTbody.appendChild(tr);
  });
}

function renderMonthTable(k) {
  dlgMonths.innerHTML = "";
  const table = document.createElement("table");
  table.className = "table";
  table.innerHTML = `
    <thead>
      <tr>
        <th>Periodo</th>
        <th>Linea A</th>
        <th>Linea B</th>
        <th>Total</th>
        <th>Meta</th>
        <th>Pres.</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tb = table.querySelector("tbody");
  const ultimos12 = DATA.periodosAll.slice(-12);
  ultimos12.forEach((per) => {
    const h = k.hist[per];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${fmtPeriodo(per)}</td>
      <td>${fmt(h.seg.A, k.u)}</td>
      <td>${fmt(h.seg.B, k.u)}</td>
      <td>${fmt(h.a, k.u)}</td>
      <td>${fmt(h.meta, k.u)}</td>
      <td>${fmt(h.pres, k.u)}</td>
    `;
    tb.appendChild(tr);
  });
  dlgMonths.appendChild(table);
}

/* =================== CAUSA EFECTO =================== */

const REL_EDGES = [
  {
    from: "APR",
    to: "PRO",
    intra: false,
    pos: [
      { label: "Horas de capacitacion", kpi: "Horas de capacitacion por persona" },
      { label: "Ideas de mejora", kpi: "Ideas de mejora implementadas" }
    ],
    neg: [{ label: "Roles criticos sin cubrir", kpi: "Cobertura de roles criticos" }]
  },
  {
    from: "PRO",
    to: "CLI",
    intra: false,
    pos: [
      { label: "OEE", kpi: "OEE" },
      { label: "MTBF", kpi: "MTBF" }
    ],
    neg: [
      { label: "Scrap", kpi: "Scrap" },
      { label: "MTTR", kpi: "MTTR" }
    ]
  },
  {
    from: "CLI",
    to: "FIN",
    intra: false,
    pos: [
      { label: "OTIF", kpi: "OTIF" },
      { label: "NPS", kpi: "NPS" }
    ],
    neg: [
      { label: "Reclamos", kpi: "Reclamos por mil ordenes" },
      { label: "Reacuerdos", kpi: "Tasa de reacuerdos" }
    ]
  }
];

const svgMap = $("#map");
const relList = $("#relList");

function drawMap(periodo) {
  svgMap.innerHTML = "";
  const W = 360;
  const H = 220;
  svgMap.setAttribute("viewBox", `0 0 ${W} ${H}`);

  const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
  svgMap.appendChild(g);

  const nodes = [
    { id: "APR", x: 20, y: 20, w: 130, h: 40, t: "Aprendizaje" },
    { id: "PRO", x: 200, y: 60, w: 140, h: 40, t: "Procesos" },
    { id: "CLI", x: 20, y: 120, w: 130, h: 40, t: "Cliente" },
    { id: "FIN", x: 200, y: 160, w: 140, h: 40, t: "Finanzas" }
  ];

  function perspectiva(code) {
    const p = DATA.perspectivas.find((pp) => pp.code === code);
    return p || null;
  }

  function nstate(code) {
    const p = perspectiva(code);
    const greens = p.kpis.filter((k) => {
      const h = k.hist[periodo];
      return state(k.pol, h.a, h.meta, h.warn) === "good";
    }).length;
    const ratio = greens / p.kpis.length;
    if (ratio >= 0.7) return "good";
    if (ratio >= 0.4) return "warn";
    return "bad";
  }

  function rect(n, cls) {
    const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    r.setAttribute("x", n.x.toString());
    r.setAttribute("y", n.y.toString());
    r.setAttribute("width", n.w.toString());
    r.setAttribute("height", n.h.toString());
    r.setAttribute("rx", "8");
    r.setAttribute("fill", "#020617");
    r.setAttribute("stroke", "#334155");
    r.setAttribute("stroke-width", "1.2");
    g.appendChild(r);

    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", (n.x + n.w / 2).toString());
    text.setAttribute("y", (n.y + n.h / 2 + 4).toString());
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("fill", "#e5e7eb");
    text.setAttribute("font-size", "11");
    text.textContent = n.t;
    g.appendChild(text);

    const badge = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    badge.setAttribute("cx", (n.x + n.w - 8).toString());
    badge.setAttribute("cy", (n.y + 10).toString());
    badge.setAttribute("r", "5");
    badge.setAttribute(
      "fill",
      cls === "good" ? "#22c55e" : cls === "warn" ? "#facc15" : "#f97373"
    );
    g.appendChild(badge);
  }

  const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
  const m = document.createElementNS("http://www.w3.org/2000/svg", "marker");
  m.id = "arr";
  m.setAttribute("viewBox", "0 0 10 10");
  m.setAttribute("refX", "10");
  m.setAttribute("refY", "5");
  m.setAttribute("markerWidth", "6");
  m.setAttribute("markerHeight", "6");
  m.setAttribute("orient", "auto-start-reverse");
  const pth = document.createElementNS("http://www.w3.org/2000/svg", "path");
  pth.setAttribute("d", "M0 0 10 5 0 10z");
  pth.setAttribute("fill", "#60a5fa");
  m.appendChild(pth);
  defs.appendChild(m);
  svgMap.appendChild(defs);

  function nodeById(id) {
    return nodes.find((n) => n.id === id);
  }

  function arrow(from, to, edge) {
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", (from.x + from.w).toString());
    line.setAttribute("y1", (from.y + from.h / 2).toString());
    line.setAttribute("x2", to.x.toString());
    line.setAttribute("y2", (to.y + to.h / 2).toString());
    line.setAttribute("stroke", "#60a5fa");
    line.setAttribute("stroke-width", "2");
    line.setAttribute("marker-end", "url(#arr)");
    g.appendChild(line);

    const mx = (from.x + from.w + to.x) / 2;
    const my = (from.y + from.h / 2 + to.y + to.h / 2) / 2;

    const stPos = aggregateState(edge.pos, periodo);
    const stNeg = aggregateState(edge.neg, periodo);

    const tPos = document.createElementNS("http://www.w3.org/2000/svg", "text");
    tPos.setAttribute("x", mx.toString());
    tPos.setAttribute("y", (my - 8).toString());
    tPos.setAttribute("text-anchor", "middle");
    tPos.setAttribute("fill", stateColor(stPos));
    tPos.setAttribute("font-size", "9");
    tPos.textContent = "+ " + edge.pos.map((d) => d.label).join(", ");
    g.appendChild(tPos);

    const tNeg = document.createElementNS("http://www.w3.org/2000/svg", "text");
    tNeg.setAttribute("x", mx.toString());
    tNeg.setAttribute("y", (my + 12).toString());
    tNeg.setAttribute("text-anchor", "middle");
    tNeg.setAttribute("fill", stateColor(stNeg));
    tNeg.setAttribute("font-size", "9");
    tNeg.textContent = "- " + edge.neg.map((d) => d.label).join(", ");
    g.appendChild(tNeg);
  }

  rect(nodes[0], nstate("APR"));
  rect(nodes[1], nstate("PRO"));
  rect(nodes[2], nstate("CLI"));
  rect(nodes[3], nstate("FIN"));

  REL_EDGES.forEach((e) => {
    const from = nodeById(e.from);
    const to = nodeById(e.to);
    arrow(from, to, e);
  });

  relList.innerHTML = "";
  REL_EDGES.forEach((e) => {
    const row = document.createElement("div");
    row.className = "relRow";

    const title = document.createElement("div");
    title.className = "relTitle";
    const fromP = perspectiva(e.from).nombre;
    const toP = perspectiva(e.to).nombre;
    title.textContent = fromP + " -> " + toP;
    row.appendChild(title);

    const chipsDiv = document.createElement("div");
    chipsDiv.className = "relChips";

    e.pos.forEach((d) => {
      const st = getKPIStateForPeriod(d.kpi, periodo) || "warn";
      const span = document.createElement("span");
      span.className = "chipPos";
      span.style.borderColor = stateColor(st);
      span.style.color = stateColor(st);
      span.textContent = "+ " + d.label;
      chipsDiv.appendChild(span);
    });

    e.neg.forEach((d) => {
      const st = getKPIStateForPeriod(d.kpi, periodo) || "warn";
      const span = document.createElement("span");
      span.className = "chipNeg";
      span.style.borderColor = stateColor(st);
      span.style.color = stateColor(st);
      span.textContent = "- " + d.label;
      chipsDiv.appendChild(span);
    });

    row.appendChild(chipsDiv);
    relList.appendChild(row);
  });
}

/* Narrativa explicativa */

function estadoPalabra(st) {
  if (st === "good") return "favorable";
  if (st === "warn") return "en alerta";
  return "tensionado";
}

function renderNarrative(periodo) {
  narrativaDiv.innerHTML = "";
  const titulo = document.createElement("h3");
  titulo.textContent = "Como leer las relaciones en este periodo";
  narrativaDiv.appendChild(titulo);

  REL_EDGES.forEach((e) => {
    const pFrom = DATA.perspectivas.find((p) => p.code === e.from);
    const pTo = DATA.perspectivas.find((p) => p.code === e.to);

    const stPos = aggregateState(e.pos, periodo);
    const stNeg = aggregateState(e.neg, periodo);

    const posNombres = e.pos.map((d) => d.label).join(", ");
    const negNombres = e.neg.map((d) => d.label).join(", ");

    const p = document.createElement("p");
    p.textContent =
      "Entre " +
      pFrom.nombre +
      " y " +
      pTo.nombre +
      " los indicadores que impulsan el resultado (" +
      posNombres +
      ") se encuentran en un estado " +
      estadoPalabra(stPos) +
      ", mientras que los indicadores que pueden presionar el desempeño (" +
      negNombres +
      ") estan " +
      estadoPalabra(stNeg) +
      ". Esto ayuda a identificar que temas conviene priorizar para sostener la rentabilidad de Masterpol.";
    narrativaDiv.appendChild(p);
  });
}

/* =================== RENDER GENERAL =================== */

function renderAll() {
  const periodo = selPeriodo.value;
  renderSummary(periodo);
  renderBlocks(periodo, $("#q").value.trim());
  drawMap(periodo);
  renderNarrative(periodo);
}

/* =================== LISTENERS =================== */

$("#btnUpd").addEventListener("click", renderAll);
$("#q").addEventListener("input", (e) => {
  renderBlocks(selPeriodo.value, e.target.value.trim());
});

/* =================== INICIO =================== */

renderAll();
